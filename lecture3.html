<!DOCTYPE html>
<!--
    Middleware and Web Services, CTU course slides
    (cc) 2010-2011 Tomas Vitvar, http://vitvar.com
    written for Humla, an open source HTML5 presentation environment
-->
<html>  
    <head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/> 
        <meta name="course"   content="Middleware and Web Services"/>
		<meta name="lecture"  content="Lecture 3"/>
   		<meta name="keywords" content="HTTP, Web Server, Synchronous, Asynchronous, Statelessness"/>
           
        <link type="text/css" rel="stylesheet" href="css/meta.css"></link>   
        <link type="text/css" rel="stylesheet" href="css/ctu-fit.css"></link>   
        <link type="text/css" rel="stylesheet" href="humla/lib/core/humla.css"></link>   

        <script type="text/javascript" src="humla/lib/humla.js"></script>
        <title>Application Server</title>
	</head>
	
	<body>
		<footer>
			<p><b>#META_LECTURE#: #TITLE#</b>,&nbsp;<span class="meta_semester"/>,&nbsp;
			<span class="meta_twitter"/></p>
			<p><b>&#8210; #SLIDE_NO# &#8210;</b></p>
		</footer>

    	<div class="slide intro">
			<hgroup>
				<h1><span class="meta_course"/></h1>
 				<h2>#META_LECTURE#: #TITLE#</h2>
			</hgroup>
			<div class="author">
				<p class="meta_author"/>
				<p><span class="meta_email"/> &bull; <span class="meta_twitter"/> &bull; 
				<span class="meta_web"/></p>
			</div>
			<center><div class="meta_logo"></div></center>
			<div class="org">
				<p class="meta_org"/>
				<p><span class="meta_orgfac"/> &bull; <span class="meta_field"/> 
				&bull; <span class="meta_orgweb"/></p>
			</div>
			<div class="etc">
        		<div class="text-info">
    				Modified: #LAST_MODIFIED#<br/>
					Humla v#HUMLA_VERSION#
				</div>
				<a href="http://creativecommons.org/licenses/by-sa/3.0/"><div class="license"></div></a>
				<div class="oppa"></div>
			</div>
		</div>
        
        <div class="slide">
            <hgroup>
                <h1>Application Server</h1>
            </hgroup>  
            <ul class="small">
                <li>Environment that runs an application logic</li>
                <ul>
                    <li>Client communicates with AS via an application protocol</li>
                </ul>
                <li>Terminology</li>
                <ul>
                    <li>Application Server &times; Web Server &times; HTTP Server</li>
                    <ul>
                        <li>AS is a modular environment; provides technology to realize enterprise systems</li>
                        <li>AS contains a Web server/HTTP server</li>
                    </ul>
                    <li>We will use AS, Web/HTTP server interchangeably</li>
                </ul>
                <li>Two major models to realize AS</li>
                <ul>
                    <li>Blocking I/O (also called synchronous I/O)</li>
                    <li>Non-blocking I/O (also called asynchronous I/O)</li>
                </ul>
                <li>Two technologies we will look at</li>
                <ul>
                    <li>Node.js &ndash; runs server-side Javascript</li>
                    <li>Java Enterprise Edition (JEE) &ndash; servlet technology</li>
                </ul>
            </ul>                
        </div>

        <div class="slide outline"></div>

        <section>
            <header>Blocking and Non-Blocking I/O</header>        

            <div class="slide"> 
				<hgroup> 
					<h1>Blocking I/O Model</h1> 
				</hgroup> 
				<ul class="small">
					<li>The server creates a thread for every connection</li>
                    <ul>                    
                        <li>For example, 1K connections = 1K threads, big overhead</li>
                    </ul>
                </ul>
    			<div id="1QP7gZSS1WS3YquzLekSgdZfcmi4BYArm-K9tuWrULQs" class="h-drawing" style="height: 220px"></div>
                <ul class="small">
                    <li>Characteristics</li>
                    <ul>
    					<li>the thread is reserved for the connection</li>
					<li>When processing of the request requires other interactions with DB/FS or network 
						communication is slow</li>
                    <ul>
                        <li>scales very bad as the thread's execution is "blocked"</li>
                    </ul>
				</ul>
			</div>

            <div class="slide"> 
    			<hgroup> 
					<h1>Non-Blocking I/O Model</h1> 
				</hgroup> 
				<ul class="small">
					<li>Connections maintained by the OS, not the Web app</li>
                    <ul>                    
                        <li>The Web app registers events, OS triggers events when occur</li>
                    </ul>
                </ul>
    			<div id="1kxkFc3Chl4qFXxH_4f2seuNbpBdENMyZWMRUmxd1p28" class="h-drawing" style="height: 220px"></div>
                <ul class="small">
					<li>Characteristics</li>
                    <ul>
                        <li>Event examples: new connection, read, write, closed</li>
					    <li>The app may create working threads, but controls the number!</li>
                        <ul>
					        <li>much less number of working threads as opposed to blocking I/O</li>
                        </ul>
                    </ul>
				</ul>
			</div>

			<div class="slide"> 
				<hgroup> 
					<h1>Node.js</h1> 
				</hgroup>
				<ul class="x-small">
					<li><span id="nodejs" class="h-ref">Node.js</span></li>
					<ul>
					    <li>Emerging Web server technology, very efficient and fast!</li>
                        <li>Event-driven I/O framework, based on JavaScript V8 engine</li>
                        <li>Only one worker thread</li>
    					<li>Open sourced, <span id="nodejs-github" class="h-ref">@GitHub</span>, many <span id="nodejs-libs" class="h-ref">libraries</span></li>
                        <li>Future platform for Web 2.0 apps</li>
                    </ul>
					<li>Every I/O as an event</li>
                    <ul>
                        <li>reading and writing from/to files</li>
                        <li>reading and writing from/to sockets</li>
						<pre class="brush: js; class-name: ''">
    						// pseudo code; ask for the last edited time of a file
    						stat( 'somefile', function( result ) {
    						  // use the result here
    						} );
                            </pre>
                    </ul>
                    <li>We will use it throughout the course for examples</li>
                    <ul>
                        <li>good to demonstrate underlying Web services concepts</li>
                    </ul>
				</ul>
			</div>

    		<div class="slide"> 
				<hgroup> 
					<h1>Quick JavaScript Intro</h1> 
				</hgroup>
				<ul class="xx-small">
                    <li>Objects and Arrays (~ JSON)</li>
    				<pre class="brush: js; class-name: 'tight'">
                        // objects - key/value pairs
                        var obj = { name: "Tomas", main-city : "Innsbruck", value : 3 };
                        obj.name = "Peter"; // assign the name property another value
                        obj["main-city"] = "Prague"; // another way to access object's values; it's not an array!
                        
                        // arrays
                        var a = ["Tomas", "Peter", "Alice"];
                        for (var i = 0; i < a.length; i++)
                            // do something with a[i]
                            
                        // combinations of arrays and objects
                        var obj_a = [ 
                            { name: "Tomas", city: "Innsbruck" }, 
                            { name : "Peter", city : "Prague" }, 
                            { name : "Alice", cities : ["Prague", "Brno"] } ];
                            
                        for (var i = 0; i < obj_a.length; i++)
                            // do something with obj_a[i].name, ...
                    </pre>                                                            
                    <li>Functions</li>
    				<pre class="brush: js; class-name: 'tight'">
                        // assign a function to a variable
                        var minus = function(a, b) {
                            return a - b;
                        }
                        
                        // call the function; 
                        // now you can pass 'minus' as a parameter to another function
                        var r2 = minus(6, 4);                        
                    </pre>                    
                    
				</ul>
			</div>
            
        	<div class="slide"> 
				<hgroup> 
					<h1>Quick JavaScript Intro (Cont.)</h1> 
				</hgroup>
				<ul class="xx-small">
                    <li>Function Callbacks</li>
                    <ul>    
                        <li>You can use them to handle asynchronous events occurrences</li>                        
                    </ul>
    				<pre class="brush: js; class-name: 'tight'">
                        // function returns the result through a callback, not directly; 
                        // this is not a non-blocking I/O, just demonstration of the callback
                        function add(a, b, callback) {
                            callback(a + b);
                        }
                        
                        // assign the callback to a variable
                        var print = function(result) {
                            console.log(result);
                        };
                        
                        // call the function with callback as a parameter
                        add(7, 8, print);
                    </pre>  
                    <li>Functions as values in object</li>
        			<pre class="brush: js; class-name: 'tight'">
                        var obj = {
                            data : [2, 3, "Tomas", "Alice", 4 ],
                            
                            getIndexdOf : function(val) {
                                for (var i = 0; i < this.data.length; i++)
                                    if (data[i] == val)
                                        return i;
                                return -1;
                            }                            
                        }
                        
                        obj.getIndexOf(3); // will return 2
                    </pre>  
				</ul>
			</div>
            
            
        </section>

        <div class="slide outline"></div>
        
        <section>
            <header>Application Protocols</header>
            
            <div class="slide">
                <hgroup>
                    <h1>Application Protocols</h1>
                </hgroup>                
                <ul class="x-small">
                    <li>Remember this</li>
                </ul>
                <div class="h-drawing" id="19zJkisQOr32yxVeMcXEi7B3fHAtSot0c_ppDJeKl4bc" style="height: 120px; margin-top: -10px"></div>
                <ul class="x-small">
                    <li>App protocols mostly on top of the TCP Layer</li>
                    <ul>
                        <li>use TCP socket for communication</li>
                    </ul>
                    <li>Major protocols</li>
                    <ul>
                        <li>HTTP &#150; most of the app protocols layered on HTTP</li>
                        <ul>
                            <li>wide spread, but: implementors often break HTTP semantics</li>                            
                        </ul>
                        <li>RMI &#150; Remote Method Invocation</li>
                        <ul>
                            <li>Java-specific, rather interface</li> 
                            <li>may use HTTP underneath (among other things)</li>
                        </ul>
                        <li>XML-RPC &#150; Remote Procedure Call and SOAP</li>
                        <ul>
                            <li>Again, HTTP underneath</li>
                        </ul>
                        <li>WebSocket &#150; new protocol part of HTML5</li>                        
                    </ul>
                </ul>
            </div>
            
            <div class="slide">
                <hgroup>
                    <h1>Socket</h1>
                </hgroup>            
				<div class="h-drawing" style="height: 140px" 
                    id="1Z4OmMLdUPPmmfAsENj7zBb_kjDOWVUzku50WucxpePU"></div>
				<ul class="xx-small">
					<li>Handshaking (connection establishment)</li>
					<ul>
                        <li>The server listens at <code>[dst_ip,dsp_port]</code></li>
                        <li>Three-way handshake:</li>
                        <ul>
                            <li>the client at <code>[src_ip,src_port]</code> sends a connection request</li> 
                            <li>the server responds</li>
                            <li>the client acknowledges the response, can send data along</li>
                        </ul>
                        <li>Result is a socket (virtual communication channel) with unique identification:<br/>
						<code>socket=[src_ip,src_port;dst_ip,dst_port]</code></li>
					</ul>
					<li>Data transfer (resource usage)</li>
					<ul>
						<li>Client/server writes/reads data to/from the socket</li>
                        <li>TCP features: reliable delivery, correct order of packets, flow control</li> 
					</ul>
					<li>Connection close</li>
				</ul>
            </div>

            <div class="slide">
                <hgroup>
                    <h1>Addressing in Application Protocol</h1>
                </hgroup>            
    			<div class="h-drawing" style="height: 220px" 
                    id="1a6OhSNel7-1HC-NaWmmkRfIOyQqlvaoXGyJws1rAuZU"></div>
				<ul class="xx-small">
					<li>IP addressing: IP is an address of a machine interface</li>
                    <ul>
                        <li>A machine can have multiple interfaces</li>
                    </ul>
                    <li>TCP addressing: TCP port is an address of an app running on a machine</li>
                    <ul>
                        <li>Multiple applications with different TCP ports may run on a machine</li>
                    </ul>
                    <li>Application addressing</li>
                    <ul>
                        <li>Additional mechanisms to address entities within an application</li>
                        <li>They are outside of scope of IP/TCP, they are app specific</li>
                        <ul>
                            <li>for example, HTTP handles multiple resources in Web application, multiple 
                            Web applications served by a single Web server (see <a href="#/http-request/">Serving HTTP Request</a>)</li>
                        </ul>
                    </ul>
                </ul>    
            </div>

            <div class="slide outline"></div>

            <section>
                <header>Synchronous and Asynchronous Communication</header>

                <div class="slide" id="sync-async-comm">
                    <hgroup>
                        <h1>Synchronous/Asynchronous Communication</h1>
                    </hgroup>   
                    <div class="h-drawing" style="height: 220px" 
                        id="14daki2YQxkRxkpg_RW16-Efihlxzhep8AWXb226NaQA"></div>                                
    				<ul class="x-small">
                        <li>Synchronous</li>
                        <ul>
            				<li>one socket, |t<sub>req</sub> &#150; t<sub>res</sub>| is small</li> 
            				<li>easy to implement and deploy, only standard firewall config</li>
            				<li>only the server defines endpoint</li>
                        </ul>
                        <li>Asynchronous</li>
                        <ul>
                            <li>request, response each has socket, client and server define endpoints</li>
            				<li>|t<sub>req</sub> &#150; t<sub>res</sub>| can be large (hours, even days)</li> 
            				<li>harder to do across network elements (private/public networks issue)</li>
                        </ul>
    				</ul>
                </div>
                
                <div class="slide">
                    <hgroup>
                        <h1>Public/Private Network Configuration</li>
                    </hgroup>
                    <div class="h-drawing" id="18RcCN5lYzGkQi1AMzmfkFgMA0JerPmcVCSjWrZj1TuQ" 
                        style="height: 270px"></div>
                    <ul class="x-small">
                        <li>Adds complexity to configuration of application</li>
                        <ul>
                            <li>Config example at server with <code>eth0 = 147.32.100.1</code> (iptables)</li>                        
                        </ul>
                        <pre class="brush: bash; class-name='xx-small'">
                            # enable ip forwarding from one interface to another within linux core
                            echo 1 > /proc/sys/net/ipv4/ip_forward
                            
                            # redirect all communication coming to tcp/3000 to 192.168.1.2:4000
                            iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 3000 -j DNAT \
                                --to-dest 192.168.1.2 --to-port 4000
                        </pre>
                    </ul>
                </div>
    
                <div class="slide">
                    <hgroup>
                        <h1>Demilitarized Zones</li>
                    </hgroup>
                    <div class="h-drawing" id="117YB9D3KXyYVXZeYlt9lHiLD9F1HbOBhcYYnxEBGeDQ" 
                        style="height: 270px"></div>
                    <ul class="x-small">
                        <li>DMZ = Demilitarized Zone</li>
                        <ul>
                            <li>subnet within an organization's network on a public network</li>
                            <li>special care of security enforced through internal policies</li>
                            <li>For example:</li>
                            <ul>
                                <li>no access to all live data, subsets copied in batches</li>
                                <li>frequent monitoring</li> 
                                <li>mechanisms to "fool" attackers</li>
                            </ul>
                        </ul>
                    </ul>
                </div>
            </section>
            
            <div class="slide outline"></div>
            
            <section>
                <header>Simple Protocol Example</header>

                <div class="slide">
                    <hgroup>
                        <h1>ASCII Communication</h1>
                    </hgroup>
                    <ul class="xx-small">
                        <li>Example simple TCP Socket protocol in NodeJS<a rel="code" 
                            href="https://github.com/tomvit/mdw-examples/blob/master/stateful-server/simple-server.js">&nbsp;</a>
                        </li>
                        <ul>
                            <li>functions (verbs): <code>add</code> and <code>bye</code></li>
                            <li>data syntax: <code>add</code> <code>"^[0-9]+ [0-9]+$"</code>, <code>bye</code> <code>"^$"</code> (regular grammars)</li>
                            <li>data semantics: <code>add</code> decimal numbers, <code>bye</code> none</li> 
                            <li>process: transitions <code>S1&#151;add&#151;S1</code>, <code>S1&#151;bye&#151;S0</code>, 
                                where <code>S0</code>, <code>S1</code> are states such that<br/>
                                <code>S1=connection established</code>, <code>S0=connection closed</code>.</li>
                        </ul>
                        <pre class="brush: js; toolbar: true">
                            var net = require('net');
                            
                            // creates the server and waits for incoming connection
                            var server = net.createServer(function (stream) {
                                stream.write('Verbs: add a b, bye.\r\n');
                             
                                // event when new data in the socket is available
                                stream.on('data', function (data) {
                                    // converts buffer to string, strip out the \r\n chars
                                    var message = new String(data.slice(0, data.length - 2));
                                    
                                    // checks for the correct format of the add message
                                    if (n = message.match("^add ([0-9]+) ([0-9]+)$"))
                                        stream.write("The result is: " + 
                                            (parseInt(n[1]) + parseInt(n[2])) + "\r\n");
                                    else
                                        if (message.match("^bye$")) stream.end("Goodbye!\r\n");
                                            else stream.write("Do not understand: " + message + "\r\n");    
                                });
                            }).listen(9900, '0.0.0.0');                
                        </pre>
                    </ul>
                </div>    
                
                <div class="slide">
                    <hgroup>
                        <h1>Testing</h1>
                    </hgroup>
                    <ul class="x-small">
                        <li>Many app protocols communicate in plain text</li>
                        <ul>
                            <li>messages in ASCII or Base64 encoded (printable chars only)</li>
                            <li>this allows to test them just with Telnet</li>
                            <ul>
                                <li>Telnet not need to know any protocol-specific semantics</li>
                                <li>only opens, reads/writes, and closes the socket</li>
                            </ul>
                        </ul>
                        <li>Testing our protocol</li>
                        <pre class="brush: bash; class-name='xx-small'">
                            # open the socket using telnet but first dig for DNS lookup
                            telnet $(dig vitvar.com +short) 9900
                            Trying 79.125.47.64...
                            Connected to ec2-79-125-47-64.eu-west-1.compute.amazonaws.com.
                            Escape character is '^]'.
                            Verbs: add a b, bye.
                            add 3 4
                            The result is: 7
                            minus 7 5
                            Do not understand: minus 7 5
                            bye
                            Goodbye!
                        </pre>
                    </ul>
                </div>    
            </section>
        </section>
        
        <div class="slide outline">
        </div>
        
        <section>
            <header>Introduction to HTTP</header>

            <div class="slide">
                <hgroup>
                    <h1>Hypertext Transfer Protocol &ndash; HTTP</h1>
                </hgroup>
                <ul class="small">
                    <li>Application protocol, basis of Web architecture</li>
                    <ul>
                        <li>Part of HTTP, URI, and HTML family</li>
                        <li>Request-response protocol</li>
                    </ul>
                    <li>One socket for single request-response</li>
                    <ul>
                        <li>original specification</li>
                        <li>have changed due to performance issues</li>
                        <ul>
                            <li>many concurrent requests</li>
                            <li>overhead when establishing same connections</li>
                            <li>HTTP 1.1 offers persistent connection and pipelining</li>
                        </ul>
                    </ul>
                    <li>HTTP is stateless</li>
                    <ul>
                        <li>Multiple HTTP requests cannot be normally related at the server</li>
                        <ul>
                            <li>"problems" with state management</li>
                            <li>REST goes back to the original HTTP idea</li>
                        </ul>
                    </ul>
                </ul>
            </div>

            <div class="slide">
                <hgroup>
                    <h1>HTTP Request and Response</h1>
                </hgroup>
                <ul class="small">
                    <li>Request Syntax</li>
                    <pre class="brush: plain; gutter: false">
                        method uri http-version &lt;crlf>
                        (header : value &lt;crlf>)* 
                        &lt;crlf>                    
                        [ data ]
                    </pre>
                    <li>Response Syntax</li>
                    <pre class="brush: plain; gutter: false">
                        http-version response-code [ message ]  &lt;crlf>
                        (header : value &lt;crlf>)* 
                        &lt;crlf>
                        [ data ]
                    </pre>
                    <li>Semantics of terms</li>
                    <pre class="brush: plain; gutter: false">
                        method         = "GET" | "POST" | "DELETE" | "PUT" | "HEAD" | "OPTIONS" 
                        uri            = [ path ] [ ";" params ] [ "?" query ] 
                        http-version   = "HTTP/1.0" | "HTTP/1.1"
                        response-code  = valid response code 
                        header : value = valid HTTP header and its value
                        data           = resource state representation (hypertext)
                    </pre>
                </ul>
            </div>
            
        	<div class="slide" id="http-request">
				<hgroup>
					<h1>Serving HTTP Request</h1>
				</hgroup>	
				<div class="h-drawing" style="height: 180px" 
				  id="1c1oNNZgurIxOEDHbnZuPHKR9I-H1VhoeOpTWa6-vslI"></div>
                <ul class="xx-small">
                    <li>IP and TCP addressing</li>
                    <ol>
                        <li>User enters URL <code>http://company.cz:8080/orders</code> to the browser</li>
                        <li>Browser gets an IP address for <code>company.cz</code>, <code>IP:138.232.189.127</code></li>
                        <li>Browser and Web Server creates a socket <code>[147.32.100.5:3223;138.232.189.127:8080]</code></li>
                    </ol>
                    <li>Application addressing</li>
                    <ol start="4">
                        <li>Browser sends HTTP request, that is, writes following data to the socket</li>
                        <pre class="brush: plain; class-name: 'tight'">
                        GET /orders HTTP/1.1
                        Host: company.cz
                        </pre>
                        <li>Web server passes the request to the web application <code>company.cz</code> which serves <code>GET orders</code> and 
                            that writes a response back to the socket.</li>                    
                    </ol>
                </ul>
			</div>

            <div class="slide">
				<hgroup>
					<h1>HTTP Server in Node.js</h1>
				</hgroup>
                <ul class="x-small">
                    <li>HTTP Server implementation</li>
                    <ul>
                        <li>server running at <code>138.232.189.127</code>, port <code>8080</code>.</li>
                        <pre class="brush: js; class-name: ''">
                            // http library
                            var http = require("http");
                            
                            http.createServer(function(req, res) {
                                // check the value of host header
                                if (req.headers.host == "company.cz") {
                                    res.writeHead(201, "Content-Type: text/plain");
                                    res.end("This is the response...");
                                } else ;
                                    // handle enterprise.com app logic...
                            }).listen('0.0.0.0', 8080);
                        </pre>  
                        <li>Test it using Telnet</li>
                        <pre class="brush: bash; class-name: ''">
                            telnet 138.232.189.127 8080
                            # ...lines omitted due to brevity
                            GET /orders HTTP/1.1
                            Host: company.cz
                            
                            HTTP/1.1 201 OK
                            Content-Type: plain/text
                            
                            This is the response...
                        </pre>  
                    </ul>
                </ul>
			</div>
            
            <div class="slide">
    			<hgroup>
					<h1>Better Support for HTTP Testing</h1>
				</hgroup>
                <ul class="x-small">
                    <li>Use <code>curl</code> to test HTTP protocol</li>
                    <pre class="brush: plain; class-name: 'tight'">
                        Usage: curl [options...] &lt;url>
                        
                        -X/--request &ltcommand>          Specify request command to use
                        -H/--header &lt;line>              Custom header to pass to server
                        -d/--data &lt;data>                HTTP POST data
                        -b/--cookie &lt;name=string/file>  Cookie string or file to read cookies from
                        -v/--verbose                    Make the operation more talkative                            
                    </pre>                        
                    <li>Example</li>
                    <pre class="brush: plain; class-name: 'tight'">
                        curl -v -H "Host: company.cz"  138.232.189.127
                        
                        * About to connect() to 138.232.189.127 port 80 
                        *   Trying 138.232.189.127... connected
                        * Connected to 138.232.189.127 port 80 
                        &gt; GET / HTTP/1.1
                        &gt; User-Agent: curl/7.20.0 (i386-apple-darwin10.3.2) libcurl/7.20.0 OpenSSL/0.9.8n
                        &gt; Accept: */*
                        &gt; Host: company.cz
                        &gt; 
                        &lt; HTTP/1.1 201 OK
                        &lt; Connection: keep-alive
                        &lt; Content-Type: plain/text
                        &lt; 
                        &lt; This is the response...                            
                    </pre>                        
                </ul>
			</div>
                
            <div class="slide outline"></div>            
            
            <section>
                <header>State Management</header>
                
                <div class="slide" id="state-management">
                    <hgroup>
                        <h1>State Management</h1>
                    </hgroup>
                    <ul class="small">
                        <li>HTTP is a stateless protocol &#150; original design</li>
                        <ul>
                            <li>No information to relate multiple interactions at server-side</li>
                            <ul>
                                <li>Except <code>Authorization</code> header is copied in every request</li> 
                                <li>IP addresses do not work, one public IP can be shared by multiple clients</li>
                            </ul>
                        </ul>
                        <li>Solutions to check for a valid state at server-side</li>
                        <ul>
                            <li><b>Cookies</b> &ndash; obvious and the most common workaround</li>
                            <ul>
                                <li><span class="h-ref" id="rfc-2109">RFC 2109 &ndash; HTTP State Management Mechanism</span></li>
                                <li>Allow clients and servers to talk in a context called <b>sessions</b></li>
                            </ul>
                            <li><b>Hypertext</b> &ndash; original HTTP design principle</li>
                            <ul>
                                <li>App states represented by resources (hypermedia), links define transitions between states</li>
                                <li>Adopted by the REST principle <b>statelessness</b></li>                        
                            </ul>
                        </ul>
                    </ul>
                </div>
                
                <div class="slide">
        			<hgroup>
    					<h1>Interaction with Cookies</h1>
    				</hgroup>
                    <ul class="small">
                        <li>Request-response interaction with cookies</li>
                        <ul>
                            <li>Session is a logical channel maintained by the server</li>
                        </ul>
                        <div class="h-drawing" style="height: 250px" id="1mVCe8EtqVApZVRV_RHYQKtqDNELKdo84qzCqGvAs7iA"></div>
                        <li>Stateful Server</li>
                        <ul>
                            <li>Server remembers the session information in a server memory</li>
                            <li>Server memory is a non-persistent storage, when server restarts the memory content is lost!</li>
                        </ul>
                    </ul>
                </div>

                <div class="slide">
                    <hgroup>
                        <h1>Set-Cookie and Cookie Headers</h1>
                    </hgroup>
                    <ul class="xx-small">
                        <li><code>Set-Cookie</code> response header</li>
                        <pre class="brush: plain; ">
                            set-cookie = "Set-Cookie:" cookie ("," cookie)*
                              cookie    = NAME "=" VALUE (";" cookie-av)*
                              cookie-av = "Comment" "=" value
                                        | "Domain" "=" value
                                        | "Max-Age" "=" value
                                        | "Path" "=" value
                        </pre>
                        <ul>
                            <li><code>domain</code> &ndash; a domain for which the cookie is applied</li>
                            <li><code>Max-Age</code> &ndash; number of seconds the cookie is valid</li>
                            <li><code>Path</code> &ndash; URL path for which the cookie is applied</li>
                        </ul>
                        <li><code>Cookie</code> request header. A client sends the cookie in a request if:</li>
                        <ul>
                            <li><code>domain</code> matches the origin server's fully-qualified host name</li>
                            <li><code>path</code> matches a prefix of the request-URI</li>
                            <li><code>Max-Age</code> has not expired</li>
                        </ul>
                        <pre class="brush: plain;">
                            cookie  = "Cookie:" cookie-value (";" cookie-value)*
                              cookie-value    = NAME "=" VALUE [";" path] [";" domain]
                              path            = "$Path" "=" value
                              domain          = "$Domain" "=" value                        
                        </pre>
                        <ul>
                            <li><code>domain</code>, and <code>path</code> are values from corresponding attributes of 
                            the <code>Set-Cookie</code> header</li>
                        </ul>
                        
                    </ul>                    
                </div>
                
                <div class="slide" id="session-object">
        			<hgroup>
    					<h1>Object for session management</h1>
    				</hgroup>
                    <pre class="brush: js; class-name: 'x-small'">
                        var sessions = {
                            // property to hold all sessions from all clients
                            sessions : {},
                        
                            // returns the session data based on the information in the cookie
                            getSession : function(req) {
                                var sid;
                        
                                // get the session id from the cookie
                                if (req.headers.cookie && (p = req.headers.cookie.match(
                                    ".*session-id=([a-zA-Z0-9]+).*")))
                                        sid = p[1];
                        
                                if (!sid || !this.sessions[sid])
                                    // create the session id md5 hash; maximum of 1000 connections 
                                    // from a single IP
                                    sid = require("crypto").createHash('md5').update(
                                        req.connection.remoteAddress + 
                                            (Math.floor(Math.random()*999))).digest("hex");
                        
                                // return the session data; 
                                // create the empty object if data does not exist
                                return this.sessions[sid] || 
                                    (this.sessions[sid] = { id : sid, data : {},
                                        header: { "Set-Cookie" : "session-id=" + sid + "; Max-Age=3600" } });
                            }
                        };
                    </pre>  
    			</div>

                <div class="slide">
            		<hgroup>
    					<h1>Stateful Server Implementation</h1>
    				</hgroup>
                    <ul class="x-small">
                        <li>Simple per-client counter<a rel="code" 
                            href="https://github.com/tomvit/mdw-examples/blob/master/stateful-server/counter.js">&nbsp;</a></li>
                        <pre class="brush: js; class-name: ''; first-line: '28'">
                            var http = require("http");
                            
                            // create the http server, handle the request
                            http.createServer(function(req, res) {
                                var session = sessions.getSession(req);
                                
                                // count number of hits from a single user
                                if (session.data.counter)
                                    session.data.counter++;
                                else
                                    // create the counter if it does not exist
                                    session.data.counter = 1;  
                            
                                // repeat the cookie in every response to keep the session
                                // the max-age value is thus an inactivity interval
                                res.writeHead(200, session.header);
                                res.end("Number of hits from you: " + session.data.counter + "\n");
                                
                            }).listen(9900, "0.0.0.0");                        
                        </pre>  
                        <li class="task">Task</li>
                        <ul>
                            <li>When server restarts, the counter will reset.</li>                    
                            <li>How do you change the code to count requests from all clients?</li>
                        </ul>
                    </ul>
    			</div>

                <div class="slide">
                	<hgroup>
    					<h1>Testing</h1>
    				</hgroup>
                    <ul class="x-small">
                        <li>Testing</li>
                        <ul>
                            <li><code>curl</code> will require you to specify cookies in every request</li>
                            <li>Browser handles cookies automatically</li>
                        </ul>
                        <pre class="brush: bash">
                            # run curl for the first time
                            curl -v ec2.vitvar.com:9900
                            > GET / HTTP/1.1
                            > Host: ec2.vitvar.com:9900
                            > Cookie: session-id=3a9c3cdc5ff36434aa1ba860727ca401
                            > 
                            &lt; HTTP/1.1 200 OK
                            &lt; Set-Cookie: session-id=3a9c3cdc5ff36434aa1ba860727ca401;max-age=3600
                            &lt; 
                            Number of hits from you: 1

                            # copy the cookie session-id from previous response
                            curl -v -b session-id=3a9c3cdc5ff36434aa1ba860727ca401 ec2.vitvar.com:9900
                            > GET / HTTP/1.1
                            > Host: ec2.vitvar.com:9900
                            > Cookie: session-id=3a9c3cdc5ff36434aa1ba860727ca401
                            > 
                            &lt; HTTP/1.1 200 OK
                            &lt; Set-Cookie: session-id=3a9c3cdc5ff36434aa1ba860727ca401;max-age=3600
                            &lt; 
                            Number of hits from you: 2
                        </pre>
                    </ul>
    			</div>

            </section>

            <div class="slide outline"></div>

            <section>
                <header>Persistent Communication and Pipelining</header>
                
        		<div class="slide">
    				<hgroup>
    					<h1>Non-Persistent, Persistent, Pipelining</h1>
    				</hgroup>
    				<div class="h-drawing" style="height: 250px; margin-bottom: 30px" 
    					id="1YgCc7gq-k3j4oWy8am9wiEg4ge0UPUk4moO6NV5W-gU"></div>
    				<ul class="x-small">
                        <li>HTTP 1.1 improvements over version 1.0</li>
                        <ul>
        					<li>non-persistent &#150; one socket for one request&ndash;response (v1.0)</li>
        					<li><b>persistent</b> &ndash; one socket for multiple interactions</li>
                            <ul>
        					    <li>reduces latency (no repeating handshaking)</li>
                            </ul>
        					<li><b>pipelining</b> &ndash; multiple requests, no wait for responses</li>
                            <ul>
        					    <li>the server must preserve the order of messages when sending responses.</li>
                            </ul>
    				    </ul>
                    </ul>
    			</div>                                    
                
            </section>

        </section>
        
        <div class="slide outline">
        </div>
        
        <section>
            <header>Introduction to JEE</header>
            
            <div class="slide">
    			<hgroup>
    				<h1>JEE</h1>
    			</hgroup>
                <ul class="small">
                    <li>Part of Java Platform, Enterprise Edition (JEE)</li>
                    <ul>
                        <li>Collection of technologies for server programming</li>
                        <li>Major technologies</li>
                        <ul>                        
                            <li>servlet technology</li>
                            <li>Java Server Pages (JSP)</li>
                            <li>Java Messaging System (JMS)</li>
                            <li>Remote Method Invocation (RMI)</li>
                            <li>Enterprise Java Beans (EJB)</li>
                        </ul>
                    </ul>
                    <li>Basis for many application servers such as</li>
                    <ul>
                        <li>Oracle WebLogic</li>
                        <li>Google AppEngine (Java)</li>
                        <li>JBoss</li>
                        <li>GlassFish</li>
                        <li>IBM WebSphere</li>
                    </ul>
                </ul>
            </div>
            
            <div class="slide">
        		<hgroup>
    				<h1>Basic Directory Structure</h1>
    			</hgroup>
                <ul class="x-small">
                    <li>Your application</li>
                    <ul>
                        <li>collection of documents and libraries your application requires</li>
                        <li>packaged in <code>war</code> archive</li>
                        <ul>
                            <li>JAR that includes not only java classes but also additional resources such as 
                            <code>.xml</code>, <code>.html</code>, <code>.js</code>, <code>.css</code>, <code>.jpg</code> files.</li>
                        </ul>
                    </ul>
                    <li>Content of <code>war</code> package</li>
                    <pre class="brush: bash; gutter: false; class-name: ''">
                        # web archive root
                        war
                         |   # directories and documents accessible through the app root /
                         |   # such as img, css, js, ...
                         |-- (public-directory | public-document)*
                         |   # directories and documents internal to your application
                         |-- WEB-INF
                                |-- (private-directory | private-document)*
                                |   # compiled java classes of your application
                                |-- classes
                                |   # all java libraries your application requires
                                |-- lib
                                |   # configuration of your application
                                |-- web.xml
                                |-- # other platform-specific configurations 
                                    # such as app-engineweb.xml for GAE
                    </pre>
                </ul>
            </div>

            <div class="slide">
                <hgroup>
    				<h1>Configuration in web.xml</h1>
    			</hgroup>
                <ul class="x-small">
                    <li><code>web.xml</code> defines configuration for</li>
                    <ul>
                        <li>list of servlets, mapping of servlets to URL paths, welcome files, filters, EJB references, 
                        authentication mechanism, etc.</li>
                        <li>basic configuration example:</li>
                    </ul>
                    <pre class="brush: xml">
                        &lt;?xml version="1.0" encoding="utf-8"?>
                        &lt;web-app 
                            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                            xmlns="http://java.sun.com/xml/ns/javaee">
                        
                            &lt;servlet>
                        		&lt;servlet-name>main&lt;/servlet-name>
                        		&lt;servlet-class>com.vitvar.mdw.main&lt;/servlet-class>
                        	&lt;/servlet>
                        
                        	&lt;servlet-mapping>
                        		&lt;servlet-name>main&lt;/servlet-name>
                        		&lt;url-pattern>/&lt;/url-pattern>
                        	&lt;/servlet-mapping>
                        
                        	&lt;welcome-file-list>
                        		&lt;welcome-file>index.jsp&lt;/welcome-file>
                        	&lt;/welcome-file-list>
                        &lt;/web-app>
                    </pre>
                </ul>
            </div>

            <div class="slide">
            	<hgroup>
    				<h1>Handling HTTP Requests</h1>
    			</hgroup>
                <ul class="x-small">
                    <li>HTTP Servlets</li>
                    <ul>
                        <li>Servlet is a class that extends capabilities of application servers 
                        via a request-response programming model</li>
                        <li>HTTP servlets are classes that extend <code>HTTPServlet</code> abstract class</li> 
                        <li>Example:</li>
                    </ul>
                    <pre class="brush: java">
                        package com.vitvar.mdw;
                        
                        import javax.servlet.http.HttpServlet;
                        import javax.servlet.http.HttpServletRequest;
                        import javax.servlet.http.HttpServletResponse;
                        
                        public class Main extends HttpServlet {
                            public doGet(HttpServletRequest request, HttpServletResponse response) {
                                // GET method implementation here
                            }

                            public doPut(HttpServletRequest request, HttpServletResponse response) {
                                // PUT method implementation here
                            }
                            
                            // other methods such as doPost, doDelete, doOptions
                        }
                    </pre>
                </ul>
            </div>

            <div class="slide">
                <hgroup>
    				<h1>Support for Sessions</h1>
    			</hgroup>
                <ul class="x-small">
                    <li><code>HttpSession</code> interface</li>
                    <ul>
                        <li>Allows to store session data in the memory</li>
                        <li>Java API for <a href="#/state-management">HTTP State Management</a></li>
                        <ul>
                            <li>Hides details to developers</li>
                        </ul>
                        <li>Enable sessions in GAE by setting <code>&ltsessions-enabled></code> to <code>true</code> 
                            in <code>appengine-web.xml</code> (disabled by default)</li>
                    </ul>
                    <pre class="brush: java;">
                        // method doGet in a servlet
                        public doGet(HttpServletRequest request, HttpServletResponse response) {
                            // access the session object through the request
                            HttpSession session = request.getSession();
                            
                            // unique identification of the session, the value used for the cookie
                            String id = session.getId();
                            
                            // get the value of the attribute
                            Object value = session.getAttribute("data");

                            // set the value of the attribute
                            session.setAttribute("data", new String("some data"));
                                                        
                            // this will set a max-age of the session cookie 
                            session.setMaxInactiveInterval(3600);
                        }
                    </pre>
                </ul>
            </div>


        </section>


    </body>
</html>
        
        
